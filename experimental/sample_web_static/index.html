<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>IREE Static Web Sample</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://code.createjs.com/1.0.0/easeljs.min.js"></script>
</head>

<body style="background-color: #35363b; color: #ABB2BF">
  <h1>IREE Static Web Sample</h1>

  <canvas id="drawingCanvas" width="256" height="256"
          style="border:2px solid #000000; background-color: #FFFFFF;"
          oncontextmenu="return false;">
  </canvas>
  <canvas id="rescaledCanvas" width="28" height="28"
          style="border:2px solid #000000; background-color: #FFFFFF;">

  <script>
    var Module = {
      print: function (text) {
        console.log(text);
      },
      printErr: function (text) {
        console.error(text);
      },
      onRuntimeInitialized: function () {
        console.log("wasm module onRuntimeInitialized");
        testLoadedModule();
      },
      // https://emscripten.org/docs/api_reference/module.html#Module.noInitialRun
      noInitialRun: true,
    };

    // going to want to run the invocation off worker
    // so may need some web worker boilerplate


  function testLoadedModule() {
    setupSample = Module.cwrap("setup_sample", "number", []);
    cleanupSample = Module.cwrap("cleanup_sample", null, ["number"]);
    runSample = Module.cwrap("run_sample", null, ["number"]);

    state = setupSample();
    runSample(state);
    cleanupSample(state);
  };

  </script>
  <script src="sample-web-static-sync.js"></script>
  <!-- <script src="sample-web-static-multithreaded.js"></script> -->


  <script>
    // Forked from:
    //   https://createjs.com/demos/easeljs/curveto
    //   https://github.com/CreateJS/EaselJS/blob/master/examples/CurveTo.html

    let drawingCanvasElement;
    let rescaledCanvasElement, rescaledCanvasContext;
    let stage;
    let drawingCanvasShape;
    let oldPt, oldMidPt;
    let titleText;
    const primaryColor = "#000000";
    const eraseColor = "#FFFFFF";
    const stroke = 32;

    function initDrawing() {
      drawingCanvasElement = document.getElementById("drawingCanvas");

      rescaledCanvasElement = document.getElementById("rescaledCanvas");
      rescaledCanvasContext = rescaledCanvasElement.getContext("2d");
      rescaledCanvasContext.imageSmoothingEnabled = false;
      rescaledCanvasContext.mozImageSmoothingEnabled = false;
      rescaledCanvasContext.webkitImageSmoothingEnabled = false;
      rescaledCanvasContext.msImageSmoothingEnabled = false;

      stage = new createjs.Stage(drawingCanvasElement);
      stage.autoClear = false;
      stage.enableDOMEvents(true);

      createjs.Touch.enable(stage);
      createjs.Ticker.framerate = 24;

      stage.addEventListener("stagemousedown", handleMouseDown);
      stage.addEventListener("stagemouseup", handleMouseUp);

      drawingCanvasShape = new createjs.Shape();
      stage.addChild(drawingCanvasShape);

      // Add instruction text.
      titleText = new createjs.Text("Click and Drag to draw", "18px Arial", "#000000");
      titleText.x = 30;
      titleText.y = 100;
      stage.addChild(titleText);

      stage.update();
    }

    function handleMouseDown(event) {
      if (!event.primary && !event.secondary) { return; }

      if (stage.contains(titleText)) {
        stage.clear();
        stage.removeChild(titleText);
      }

      oldPt = new createjs.Point(stage.mouseX, stage.mouseY);
      oldMidPt = oldPt.clone();
      stage.addEventListener("stagemousemove", handleMouseMove);
    }

    function handleMouseMove(event) {
      if (!event.primary && !event.secondary) { return; }

      const midPt = new createjs.Point(
        oldPt.x + stage.mouseX >> 1, oldPt.y + stage.mouseY >> 1);

      const color = event.nativeEvent.which == 1 ? primaryColor : eraseColor;
      drawingCanvasShape.graphics.clear()
          .setStrokeStyle(stroke, 'round', 'round')
          .beginStroke(color).moveTo(midPt.x, midPt.y)
          .curveTo(oldPt.x, oldPt.y, oldMidPt.x, oldMidPt.y);

      oldPt.x = stage.mouseX;
      oldPt.y = stage.mouseY;
      oldMidPt.x = midPt.x;
      oldMidPt.y = midPt.y;

      stage.update();
      updateRescaledCanvas();
    }

    function handleMouseUp(event) {
      if (!event.primary && !event.default) { return; }
      stage.removeEventListener("stagemousemove", handleMouseMove);
    }

    function updateRescaledCanvas() {
      rescaledCanvasContext.drawImage(
          drawingCanvasElement,
          /*sx=*/0, /*sy=*/0,
          /*sWidth=*/256, /*sHeight=*/256,
          /*dx=*/0, /*dy=*/0,
          /*dWidth=*/28, /*dHeight=*/28);
    }

    function getRescaledCanvasData() {
      return rescaledCanvasContext.getImageData(0, 0, 28, 28);
    }

    initDrawing();
  </script>
</body>

</html>
